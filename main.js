/** rKey */
rKey = '45ef3e9d2b2296d56accc8c88910d66baaaace5d';
/** 銘柄コード */
// stockCodeList = [8698,8306,1357,4689,6501,8604,9501,7201,6723,4005,5020,4755,6702,8308,2768,5301,6178,6752,1570,8601,4503,3436,2914,6758,8316,7211,9831,9433,8031,6503,8410,8002,9984,8750,4502,8001,4188,6301,1605,7203,5406,7261,9437,6472,8802,7267,7751,8058,3402,6098,6504,8591,8354,8515,6857,8473,8358,7186,6506,2930,8053,7167,9613,8801,9432,4344,7270,1812,9503,3407,8331,4528,6471,8572,6770,5401,7752,1332,8267,5411,2503,6326,4902,3659,4004,1803,2160,3661,3861,3382,9508,5802,1306,8795,6479,1802,3289,9972,1928,8359,9502,8355,3092,6976,7974,5232,4597,4911,8233,8927,5803,5108,3236,6952,3825,3656,6366,6724,6474,7731,7205,8766,8848,5713,2337,4042,9101,7272,7182,2432,4568,6630,7911,9064,6507,4824,3086,3632,6902,2802,4321,4452,7202,7180,6971,8725,8830,3099,6467,5563,1963,4901,6674,9201,6113,4594,7762,5333,6753,4202,1925,7269,4543,3660,8697,6481,3197,9506,7012,8035,2191,9005,9505,8334,1808,4507,6473,8593,4204,7011,9504,3784,6460,4506,3941,6954,8113,9509,9531,4063,4570,2413,8252,9519,2427,2502,5727,9024,6754,3405,9449,9202,6141,4508,4751,8418,7224,4185,4151,4587,6707,3807,8616,4217,2181,8309,5486,1893,8703,5002,8897,8630,6305,9532,7733,6632,4578,4912,8303,6988,9143,3679,5938,3401,5423,5334,7004,2379,2437,6135,8628,8253,4062,4536,6727,9697,1360,2281,8016,7867,4205,2127,3003,2371,7013,2385,8524,3558,6508,2809,3655,8804,6762,7701,4324,7936,7776,7741,6383,8893,6634,6841,7575,8729,6944,5110,9962,8714,4523,6568,6701,4579,1435,6981,8029,3048,9104,2497,1719,4613,4519,8282,8028,5706,4666,6594,4183,4118,1821,1824,4927,7832,3132,3186,3668,7965,6645,4739,8609,9270,6367,9412,9020,4676,6967,2193,3053,5202,7912,9076,8379,6101,9517,9507,5711,6804,2871,5105,7003,9983,1801,5413,4203,2212,7518,8015,7779,1721,2338,3793,5901,4563,5214,6963,2170,9021,3696,7951,6104,3853,6807,5201,6448,2492,4043,2267,2002,4182,3105,3624,8739,1860,6395,6034,6268,4974,2929,8086,2433,2176,9766,1699,6586,5332,7148,6047,4704,3231,5801,8385,2531,5991,7725,5019,3064,2667,3291,4980,2743,2158,2229,9513,6302,3938,9404,6240,5912,7550,5453,9007,7599,6888,2801,4586,4768,4208,9735,2579,3415,8933,3782,6058,2685,5929,4461,6755,8876,2120,4021,3050,4680,4272,6629,5017,4661,5233,6193,6951,6923,2282,7532,7274,9142,9006,1822,6768,4921,8304,5726,7956,3121,9069,2303,4307,3687,9684,3356,6920,7581,8036,4612,6371,9450,2784,9048,7240,5702,6184,1720,7259,3903,4743,9301,3116,4091,6622,9107,4736,5101,6432,6361,6095,1852,4681,7732,3667,7735,2121,4875,6201,6093,9861,6728,1951,8242,8020,6703,7593,6412,7984,9009,2038,4732,7915,6588,1942,9753,9001,3845,8382,6810,4571,3863,8613,2269,2928,3245,6324,6890,3103,3284,2651,3900,8905,6407,2587,7513,2453,6869,3865,1911,6816,3773,1400,6641,6999,7747,6798,2362,6552,5631,3088,8919,8570,8366,3823,2884,3808,1890,5302,5741,2389,9041,6050,8511,7459,9401,6370,4814,6571,1417,7181,6619,4061,6480,5021,9681,5358,8377,1944,3673,1820,4572,3935,5393,9399,7908,7718,6440,5704,4047,7189,3686,6143,2730,9602,2491,7276,4592,8386,3675,2467,1878,2471,4922,6134,6183,6965,3744,6787,4041,3758,3672,9843,7282,1873,3902,4312,1885,8892,1579,6871,2296,6235,6088,9303,1419,9042,3222,8923,4541,1853,5289,4631,9302,6958,8622,8508,6175,9364,7246,6861,6315,7992,7412,6966,3387,6911,7241,4565,3810,8368,7855,8544,6534,3665,2398,8202,1861,7545,6561,7616,2795,3852,4634,5357,1571,3912,3101,4516,9008,9044,9980,6436,7844,9022,8060,5809,5218,9719,6276,2168,3978,9698,6498,3626,9086,2670,6192,4813,8056,6005,9468,2931,6849,4978,8388,3106,3244,4849,4779,4544,3543,4714,6620,7251,6055,5714,9062,8934,6140,7774,6103,5463,4967,1711,3689,2681,8136,3254,6136,6464,1662,7906,6794,6417,8381,6089,2461,7717,8803,6572,7649,6995,4189,8600,6203,7744,7309,2264,3447,4527,2875,3167,3697,4290,1321,4819,8184,6146,3778,6817,8586,2593,4088,7988,6590,2327,3264,2270,3258,4403,4996,2501,1459,3189,4308,2706,7164,6200,2206,3753,6996,7818,2678,3397,6925,9832,8346,3994,8595,2438,4028,7244,6028,4186,2175,6425,1883,2331,8732,3756,1366,2489,2440,3433,4576,6274,9989,3635,6914,9743,3676,3608,9783,6592,3681,3300,6269,9945,9627,6172,9533,4997,3038,9913,4684,2146,6345,7606,3271,1333,4617,6273,9616,8783,8227,3141,5541,4284,8550,6376,3548,8439,9603,8624,6444,2811,3843,7608,2162,3267,2372,1308,3664,3906,2656,3791,5986,4540,1833,9678,7618,2130,4555,3288,2702,4045,4583,8889,3774,3662,6658,2201,4237,3678,5208,7613,5949,6532,3641,3489,6941,6879,3087,7172,6652,6882,4317,2782,2607,2874,1926,3134,6013,2157,4848,8137,9119,3932,9765,6573,2538,7157,8273,3563,6489,9307,3880,2148,3479,4708,3680,6927,8369,3844,6875,6323,8125,4686,2428,3328,2468,4763,1871,6566,1959,6856,7014,7810,6845,6264,3652,2910,8174,6664,8218,6670,8219,9830,2412,6079,3138,7516,7198,3333,1458,2897,6569,9706,3769,5911,2749,4348,6644,4109,9948,4401,5122,3927,8050,6071,9987,4924,9409,4246,6330,6538,8844,7994,6118,7313,3923,6177,2288,3040,7453,9416,6081,5707,2154,6338,6469,9045,6997,6208,3391,2810,9003,6465,2124,3799,6312,8341,9716,9065,1934,7970,5363,8890,3192,8127,9836,3688,7860,6862,6904,5857,4556,7296,8129,9757,1898,4845,9474,3561,4664,4275,8360,3909,1356,1305,3966,3179,4530,6418,2351,2695,6092,2533];
// stockCodeList = [8698, 8306, 1357, 4689, 6501, 8604, 9501, 7201, 6723, 4005, 5020, 4755, 6702, 8308, 2768, 5301, 6178, 6752, 1570, 8601, 4503, 3436, 2914, 6758, 8316, 7211, 9831, 9433, 8031, 6503, 8410, 8002, 9984, 8750, 4502, 8001, 4188, 6301, 1605, 7203, 5406, 7261, 9437, 6472, 8802, 7267, 7751, 8058, 3402, 6098, 6504, 8591, 8354, 8515, 6857, 8473, 8358, 7186, 6506, 2930, 8053, 7167, 9613, 8801, 9432, 4344, 7270, 1812, 9503, 3407, 8331, 4528, 6471, 8572, 6770, 5401, 7752, 1332, 8267, 5411, 2503, 6326, 4902, 3659, 4004, 1803, 2160, 3661, 3861, 3382, 9508, 5802, 1306, 8795, 6479, 1802, 3289, 9972, 1928, 8359, 9502, 8355, 3092, 6976, 7974, 5232, 4597, 4911, 8233, 8927, 5803, 5108, 3236, 6952, 3825, 3656, 6366, 6724, 6474, 7731, 7205, 8766, 8848, 5713, 2337, 4042, 9101, 7272, 7182, 2432, 4568, 6630, 7911, 9064, 6507, 4824, 3086, 3632, 6902, 2802, 4321, 4452, 7202, 7180, 6971, 8725, 8830, 3099, 6467, 5563, 1963, 4901, 6674, 9201, 6113, 4594, 7762, 5333, 6753, 4202, 1925, 7269, 4543, 3660, 8697, 6481, 3197, 9506, 7012, 8035, 2191, 9005, 9505, 8334, 1808, 4507, 6473, 8593, 4204, 7011, 9504, 3784, 6460, 4506, 3941, 6954, 8113, 9509, 9531, 4063, 4570, 2413, 8252, 9519, 2427, 2502, 5727, 9024];
stockCodeList = [8698, 8306];
/** シミュレート日数 */
simulateDay = 3600;
/** APIを1回呼ぶごとの待ち時間(ミリ秒) */
intervalTime = 2500;
/** 進捗状況(何個目の銘柄を処理中か) */
var progressNumber = 0;
/** 取引1回あたりにかかる手数料(%) */
const fee = 0;
/** 適当買いシミュレート時の生成する乱数の数( 1/??? の確率で購入) */
var purchaseTriggerRandomNumber = 200;
/** 下ヒゲシミュレート時の購入条件とする下ヒゲの長さ(%) */
var purchaseTriggerLowerShadowLength = 8;
/** 上ヒゲシミュレート時の購入条件とする上ヒゲの長さ(%) */
var purchaseTriggerUpperShadowLength = 8;
/** 2連下ヒゲシミュレート時の購入条件とする下ヒゲの長さ(%) */
var purchaseTrigger2RenLsLength = 3;
/** 底値下ヒゲシミュレート時の過去何本の足を見て底値と判断するか */
var areasJudgementStandardLsInBottom = 60;
/** 底値下ヒゲシミュレート時の購入条件とする下ヒゲの長さ(%) */
var purchaseTriggerLsInBottomLength = 3;
/** シミュレート結果(ランダム) */
randomResult = [];
/** シミュレート結果(下ヒゲ) */
lowerShadowResult = [];
/** シミュレート結果(上ヒゲ) */
upperShadowResult = [];
/** シミュレート結果(2連下ヒゲ) */
LowerShadow2RenResult = [];
/** シミュレート結果(底値下ヒゲ) */
LsInBottomResult = [];
/** シミュレート結果(確定的ダブルはらみ) */
doubleHaramiResult = [];

pricesListList = new Object();

function start() {

    regularCall();

    var i = 0;

    // 再帰関数。待ち時間付きのforみたいなイメージ
    function regularCall() {
        setTimeout(function () {
            if (i >= stockCodeList.length) {
                showResult();
                return;
            }
            call(i);
            i++;
            regularCall();
        }, intervalTime);
    }

    function call(index) {
        var url = 'https://api.kabumap.com/servlets/api/stockHists.jsp?compress=0&now=&bd=1&m=e&r=' + rKey + '&y=d&term=' + simulateDay + 'd&fd=0&pd=0&bd=1&adj=on&c=' + stockCodeList[index] + '/0&callback=qrapiCallback_2&_1527838135206=';
        $.ajax({
            url: url,
            type: 'GET',
            dataType: 'jsonp',
            timeout: 10000
        });
    }

}

function qrapiCallback_2(response) {

    progressNumber++;
    document.getElementById('progress').innerText = progressNumber + '/' + stockCodeList.length;

    var pricesList = new Object();
    pricesList['code'] = (response[0].code + '').split('/')[0];
    var tmpPriceListList = [];
    for (var i = 0; i < response[0].data.length; i++) {
        var tmpPriceList = new Object;
        // それぞれのデータを変数に格納する
        var date = response[0].data[i][0];
        var open = response[0].data[i][1];
        var high = response[0].data[i][2];
        var low = response[0].data[i][3];
        var close = response[0].data[i][4];
        var turnover = response[0].data[i][5];

        var upperShadow = calcUpperShadow(open, high, low, close);
        var lowerShadow = calcLowerShadow(open, high, low, close);

        tmpPriceList['date'] = new Date(date);
        tmpPriceList['open'] = open;
        tmpPriceList['high'] = high;
        tmpPriceList['low'] = low;
        tmpPriceList['close'] = close;
        tmpPriceList['turnover'] = turnover;
        // us = upper shadow
        tmpPriceList['us'] = upperShadow;
        // ls = lower shadow
        tmpPriceList['ls'] = lowerShadow;

        // 足の種類。ちょっと珍しいかもだけどイメージしやすいように1,0,-1で区別(1:陽線 0:ぺったんこ -1:陰線)
        if ((close - open) > 0) {
            // 終値が始値より大きければ陽線
            tmpPriceList['barType'] = 1;
        } else if ((close - open) < 0) {
            // 終値が始値より小さければ陰線
            tmpPriceList['barType'] = -1;
        } else {
            // どっちでもなければぺったんこ
            tmpPriceList['barType'] = 0;
        }

        tmpPriceListList.push(tmpPriceList);
    }
    pricesList['prices'] = tmpPriceListList;

    // pricesListList[pricesList.code] = pricesList;

    console.log(pricesList);
    simulateRandam(pricesList);
    simulateLowerShadow(pricesList);
    simulateUpperShadow(pricesList);
    simulate2RenLowerShadow(pricesList);
    simulateLsInBottom(pricesList);
    simulateDoubleHarami(pricesList);
}


/**
 * ランダムでのシミュレーション。そもそも適当にトレードしたらどうなるのかをシミュレートする
 * @param {Array<JSON>} pricesList 
 */
function simulateRandam(pricesList) {
    for (var i = 0; i < pricesList.prices.length; i++) {

        // 0~99の乱数
        var random = Math.floor(Math.random() * purchaseTriggerRandomNumber);

        // 乱数が特定の数字になったら購入(ランダム購入)
        if (random == 0) {
            // 購入時は次の足の始値で購入するため、次の足が存在しない場合はスルー
            if (!pricesList.prices[i + 1]) {
                break;
            }
            // 次の足の始値で購入する。購入時点のデータを記憶しておく。bid=入札、らしい
            const pricesAtBid = pricesList.prices[i + 1];
            i++;
            for (; i < pricesList.prices.length; i++) {
                // 購入後、陰線が出るまで保有し続ける。陰線が出たら売却。売却時も次の足の始値で売却するため、次の足のデータが存在しない場合はスルーする。
                if (pricesList.prices[i].barType == -1) {
                    if (!pricesList.prices[i + 1]) {
                        break;
                    }
                    // 次の足の始値で売却するため、次の足のデータを記憶しておく。sell=売却、でいいかな？
                    const pricesAtSell = pricesList.prices[i + 1];
                    const tmpResult = new Object();
                    tmpResult['code'] = pricesList.code;
                    tmpResult['bid'] = pricesAtBid;
                    tmpResult['sell'] = pricesAtSell;
                    randomResult.push(tmpResult);
                    i--;
                    break;
                }
            }
        }
    }
}

/**
 * 下ヒゲでのシミュレーション
 * @param {Array<JSON>} pricesList 
 */
function simulateLowerShadow(pricesList) {
    for (var i = 0; i < pricesList.prices.length; i++) {
        // 下ヒゲが一定の長さを超えたら購入
        if (pricesList.prices[i].ls >= purchaseTriggerLowerShadowLength) {
            // 購入時は次の足の始値で購入するため、次の足が存在しない場合はスルー
            if (!pricesList.prices[i + 1]) {
                break;
            }
            // 次の足の始値で購入する。購入時点のデータを記憶しておく。bid=入札、らしい
            const pricesAtBid = pricesList.prices[i + 1];
            i++;
            for (; i < pricesList.prices.length; i++) {
                // 購入後、陰線が出るまで保有し続ける。陰線が出たら売却。売却時も次の足の始値で売却するため、次の足のデータが存在しない場合はスルーする。
                if (pricesList.prices[i].barType == -1) {
                    if (!pricesList.prices[i + 1]) {
                        break;
                    }
                    // 次の足の始値で売却するため、次の足のデータを記憶しておく。sell=売却、でいいかな？
                    const pricesAtSell = pricesList.prices[i + 1];
                    const tmpResult = new Object();
                    tmpResult['code'] = pricesList.code;
                    tmpResult['bid'] = pricesAtBid;
                    tmpResult['sell'] = pricesAtSell;
                    lowerShadowResult.push(tmpResult);
                    i--;
                    break;
                }
            }
        }
    }
}

/**
 * 上ヒゲでのシミュレーション
 * @param {Array<JSON>} pricesList 
 */
function simulateUpperShadow(pricesList) {
    for (var i = 0; i < pricesList.prices.length; i++) {
        // 下ヒゲが一定の長さを超えたら購入
        if (pricesList.prices[i].us >= purchaseTriggerUpperShadowLength) {
            // 購入時は次の足の始値で購入するため、次の足が存在しない場合はスルー
            if (!pricesList.prices[i + 1]) {
                break;
            }
            // 次の足の始値で購入する。購入時点のデータを記憶しておく。bid=入札、らしい
            const pricesAtBid = pricesList.prices[i + 1];
            i++;
            for (; i < pricesList.prices.length; i++) {
                // 購入後、陰線が出るまで保有し続ける。陰線が出たら売却。売却時も次の足の始値で売却するため、次の足のデータが存在しない場合はスルーする。
                if (pricesList.prices[i].barType == -1) {
                    if (!pricesList.prices[i + 1]) {
                        break;
                    }
                    // 次の足の始値で売却するため、次の足のデータを記憶しておく。sell=売却、でいいかな？
                    const pricesAtSell = pricesList.prices[i + 1];
                    const tmpResult = new Object();
                    tmpResult['code'] = pricesList.code;
                    tmpResult['bid'] = pricesAtBid;
                    tmpResult['sell'] = pricesAtSell;
                    upperShadowResult.push(tmpResult);
                    i--;
                    break;
                }
            }
        }
    }
}

/**
 * 2連下ヒゲでのシミュレーション
 * @param {Array<JSON>} pricesList 
 */
function simulate2RenLowerShadow(pricesList) {
    for (var i = 0; i < pricesList.prices.length; i++) {
        // 下ヒゲが一定の長さを超えたら次のヒゲを調べる
        if (pricesList.prices[i].ls >= purchaseTrigger2RenLsLength) {
            // 次の下ヒゲ、その次のヒゲが存在しない場合はスルー
            if (!pricesList.prices[i + 1] || !pricesList.prices[i + 2]) {
                break;
            }
            // 2個目のヒゲの下ヒゲを調べる
            i++;
            if (pricesList.prices[i].ls >= purchaseTrigger2RenLsLength) {

                // 2個目のヒゲも条件を満たしたら購入。次のヒゲの始値で購入するため、次のヒゲのデータを記憶する
                const pricesAtBid = pricesList.prices[i + 1];

                i++;
                for (; i < pricesList.prices.length; i++) {
                    // 購入後、陰線が出るまで保有し続ける。陰線が出たら売却。売却時も次の足の始値で売却するため、次の足のデータが存在しない場合はスルーする。
                    if (pricesList.prices[i].barType == -1) {
                        if (!pricesList.prices[i + 1]) {
                            break;
                        }
                        // 次の足の始値で売却するため、次の足のデータを記憶しておく。sell=売却、でいいかな？
                        const pricesAtSell = pricesList.prices[i + 1];
                        const tmpResult = new Object();
                        tmpResult['code'] = pricesList.code;
                        tmpResult['bid'] = pricesAtBid;
                        tmpResult['sell'] = pricesAtSell;
                        LowerShadow2RenResult.push(tmpResult);
                        i--;
                        break;
                    }
                }
            }

        }
    }
}

/**
 * 底値下ヒゲでのシミュレーション
 * @param {Array<JSON>} pricesList 
 */
function simulateLsInBottom(pricesList) {

    for (var i = areasJudgementStandardLsInBottom; i < pricesList.prices.length; i++) {

        // 過去areasJudgementStandardLsInBottom個分の足の安値の中でもっとも安い安値を特定する
        minLowInArea = pricesList.prices[i - 1].low;
        for (var j = 2; j < areasJudgementStandardLsInBottom; j++) {
            if (minLowInArea > pricesList.prices[i - j].low) {
                minLowInArea = pricesList.prices[i - j].low;
            }
        }

        // 過去areasJudgementStandardLsInBottom個分の足の安値の中でもっとも安い安値よりpricesList.prices[i]の安値が安かったら、底値確定
        if (pricesList.prices[i].low < minLowInArea) {
            // 底値かつ下ヒゲの長さが特定の長さを超えたら購入
            if (pricesList.prices[i].ls >= purchaseTriggerLsInBottomLength) {
                // 購入時は次の足の始値で購入するため、次の足が存在しない場合はスルー
                if (!pricesList.prices[i + 1]) {
                    break;
                }
                // 次の足の始値で購入する。購入時点のデータを記憶しておく。bid=入札、らしい
                const pricesAtBid = pricesList.prices[i + 1];
                i++;
                for (; i < pricesList.prices.length; i++) {
                    // 購入後、陰線が出るまで保有し続ける。陰線が出たら売却。売却時も次の足の始値で売却するため、次の足のデータが存在しない場合はスルーする。
                    if (pricesList.prices[i].barType == -1) {
                        if (!pricesList.prices[i + 1]) {
                            break;
                        }
                        // 次の足の始値で売却するため、次の足のデータを記憶しておく。sell=売却、でいいかな？
                        const pricesAtSell = pricesList.prices[i + 1];
                        const tmpResult = new Object();
                        tmpResult['code'] = pricesList.code;
                        tmpResult['bid'] = pricesAtBid;
                        tmpResult['sell'] = pricesAtSell;
                        LsInBottomResult.push(tmpResult);
                        i--;
                        break;
                    }
                }
            }
        }
    }

}


/**
 * 確定的ダブルはらみでのシミュレーション
 * @param {Array<JSON>} pricesList 
 */
function simulateDoubleHarami(pricesList) {
    for (var i = 3; i < pricesList.prices.length; i++) {

        // 1本目が陰線じゃなかった場合はスルーする
        if (pricesList.prices[i - 3].barType != -1) {
            continue;
        }

        // 2本目が陽線じゃなかった場合はスルーする
        if (pricesList.prices[i - 2].barType != 1) {
            continue;
        }

        // 1本目の高値が2本目の高値より低かったら、または1本目の安値が2本目の安値より高かったら、はらみではないのでスルーする。
        if (pricesList.prices[i - 3].high <= pricesList.prices[i - 2].high || pricesList.prices[i - 3].low >= pricesList.prices[i - 2].low) {
            continue;
        }

        // 3本目が陰線じゃなかった場合はスルーする
        if (pricesList.prices[i - 1].barType != -1) {
            continue;
        }

        // 4本目が陽線じゃなかった場合はスルーする
        if (pricesList.prices[i].barType != 1) {
            continue;
        }

        // 3本目の高値が4本目の高値より低かったら、または3本目の安値が4本目の安値より高かったら、はらみではないのでスルーする。
        if (pricesList.prices[i - 1].high <= pricesList.prices[i].high || pricesList.prices[i - 1].low >= pricesList.prices[i].low) {
            continue;
        }

        // ここまでcontinueしないでたどり着いたらダブルはらみ確定

        // 購入時は次の足の始値で購入するため、次の足が存在しない場合はスルー
        if (!pricesList.prices[i + 1]) {
            break;
        }
        // 次の足の始値で購入する。購入時点のデータを記憶しておく。bid=入札、らしい
        const pricesAtBid = pricesList.prices[i + 1];
        i++;
        for (; i < pricesList.prices.length; i++) {
            // 購入後、陰線が出るまで保有し続ける。陰線が出たら売却。売却時も次の足の始値で売却するため、次の足のデータが存在しない場合はスルーする。
            if (pricesList.prices[i].barType == -1) {
                if (!pricesList.prices[i + 1]) {
                    break;
                }
                // 次の足の始値で売却するため、次の足のデータを記憶しておく。sell=売却、でいいかな？
                const pricesAtSell = pricesList.prices[i + 1];
                const tmpResult = new Object();
                tmpResult['code'] = pricesList.code;
                tmpResult['bid'] = pricesAtBid;
                tmpResult['sell'] = pricesAtSell;
                doubleHaramiResult.push(tmpResult);
                i--;
                break;
            }
        }

    }
}


/**
 * シミュレーションの結果を表示する
 */
function showResult() {

    // console.log('size=' + Object.keys(pricesListList).length);
    // console.log(pricesListList);

    calcAndShowResult('random_result_label', randomResult);
    calcAndShowResult('ls_result_label', lowerShadowResult);
    calcAndShowResult('us_result_label', upperShadowResult);
    calcAndShowResult('ls_2ren_result_label', LowerShadow2RenResult);
    calcAndShowResult('ls_inbottom_result_label', LsInBottomResult);
    calcAndShowResult('double_harami_result_label', doubleHaramiResult);

}

/**
 * 
 * @param {string} id 結果を表示するラベルのid
 * @param {Array<JSON>} resultList リザルトリスト
 */
function calcAndShowResult(id, resultList) {
    const lsResultLabel = document.getElementById(id);
    if (resultList.length == 0) {
        lsResultLabel.innerText = '一度も取引が行われませんでした';
        return;
    }
    var resultEntire = 0;
    var win = 0;
    var lose = 0;
    var draw = 0;
    var equalInterval = 1;
    for (var i = 0; i < resultList.length; i++) {
        const bidPrice = resultList[i].bid.open; // 購入時の株価
        const sellPrice = resultList[i].sell.open; // 売却時の株価
        // 結果(%) = ( ( 売った時の値段 - 買った時の値段 ) / ( 買った時の値段 ) ) * 100 であってるかな？
        var resultOnOneTrade = ((sellPrice - bidPrice) / bidPrice) * 100;
        resultOnOneTrade = resultOnOneTrade - fee;
        resultEntire += resultOnOneTrade;

        if (bidPrice < sellPrice) {
            win++;
        } else if (bidPrice > sellPrice) {
            lose++;
        } else {
            draw++;
        }

        // 適当にデータの 1/10 , 2/10 ... 地点のデータをトレード履歴として表示する。ちゃんとしたタイミングで買い、ちゃんとしたタイミングで売っているかをユーザーが確認できるようにするため。
        if (i > (resultList.length / 10) * equalInterval) {

            equalInterval++;

            const bidDate = (resultList[i].bid.date.getFullYear() + '').slice(2) + '/' + ('0' + (resultList[i].bid.date.getMonth() + 1)).substr(-2) + '/' + ('0' + resultList[i].bid.date.getDate()).substr(-2);
            const sellDate = (resultList[i].sell.date.getFullYear() + '').slice(2) + '/' + ('0' + (resultList[i].sell.date.getMonth() + 1)).substr(-2) + '/' + ('0' + resultList[i].sell.date.getDate()).substr(-2);

            var plus = '';
            if (bidPrice < sellPrice) {
                plus = '+';
            }
            lsResultLabel.innerText += resultList[i].code + '　' + bidDate + '~' + sellDate + '　' + (plus + Math.round(resultOnOneTrade * 100) / 100) + '%\n';
        }
    }

    // 期待値がプラスだった場合は数字の先頭に「+」をつける
    var plus = '';
    if (resultEntire > 0) {
        plus = '+';
    }
    lsResultLabel.innerText = '期待値 = ' + plus + (resultEntire / resultList.length) + '%\n' + win + '勝 ' + lose + '敗 ' + draw + '分け (勝率:' + Math.round(((win * 100) / (win + lose + draw)) * 100) / 100 + '%)\n\n' + lsResultLabel.innerText;
}

/**
* 上ヒゲの長さを計算する(株価全体に対するパーセンテージ)
* @param {number} open 
* @param {number} high 
* @param {number} low 
* @param {number} close 
*/
function calcUpperShadow(open, high, low, close) {
    var upperShadowLength = high - Math.max(open, close);
    if (upperShadowLength == 0) {
        return 0;
    }
    var upperShadowPercentForAll = (upperShadowLength / high) * 100;

    return upperShadowPercentForAll;
}

/**
 * 下ヒゲの長さを計算する(株価全体に対するパーセンテージ)
 * @param {number} open 
 * @param {number} high 
 * @param {number} low 
 * @param {number} close 
 */
function calcLowerShadow(open, high, low, close) {
    var lowerShadowLength = Math.min(open, close) - low;
    if (lowerShadowLength == 0) {
        return 0;
    }
    var lowerShadowPercentForAll = (lowerShadowLength / high) * 100;

    return lowerShadowPercentForAll;
}